#!/bin/bash

# Unofficial bash strict mode http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -eu
set -o pipefail
IFS=$'\n\t'

SABNZBD_API_KEY=$(aws ssm get-parameter --region eu-west-1 --name sabnzbd.api_key --with-decryption --query "Parameter.Value" --out text)
COUCHPOTATO_API_KEY=$(aws ssm get-parameter --region eu-west-1 --name couchpotato.api_key --with-decryption --query "Parameter.Value" --out text)
NZBGEEK_API_KEY=$(aws ssm get-parameter --region eu-west-1 --name nzbgeek.api_key --with-decryption --query "Parameter.Value" --out text)
PLEX_TOKEN=$(aws ssm get-parameter --region eu-west-1 --name plex.token --with-decryption --query "Parameter.Value" --out text)

unset AWS_ACCESS_KEY_ID
unset AWS_SECRET_ACCESS_KEY
unset AWS_SESSION_TOKEN
unset AWS_REGION

cat /app/couchpotato.ini \
  | sed "s|COUCHPOTATO_API_KEY|$COUCHPOTATO_API_KEY|" \
  | sed "s|SABNZBD_API_KEY|$SABNZBD_API_KEY|" \
  | sed "s|NZBGEEK_API_KEY|$NZBGEEK_API_KEY|" \
  | sed "s|PLEX_TOKEN|$PLEX_TOKEN|" \
  > /tmp/couchpotato.ini

exec ${*:1}
