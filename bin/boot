#!/bin/bash

# Unofficial bash strict mode http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -eu
set -o pipefail
IFS=$'\n\t'

HOST_IP=$(/sbin/ip route | awk '/default/ { print $3 }')

cat /app/couchpotato/couchpotato.ini \
  | sed "s|COUCHPOTATO_API_KEY|$COUCHPOTATO_API_KEY|" \
  | sed "s|COUCHPOTATO_PORT|$COUCHPOTATO_PORT|" \
  | sed "s|SABNZBD_API_KEY|$SABNZBD_API_KEY|" \
  | sed "s|SABNZBD_HOST|$HOST_IP|" \
  | sed "s|SABNZBD_PORT|$SABNZBD_PORT|" \
  | sed "s|TRANSMISSION_HOST|$HOST_IP|" \
  | sed "s|TRANSMISSION_PORT|$TRANSMISSION_PORT|" \
  | sed "s|PLEX_HOST|$HOST_IP|" \
  | sed "s|PLEX_PORT|$PLEX_PORT|" \
  | sed "s|NZBGEEK_API_KEY|$NZBGEEK_API_KEY|" \
  > /tmp/couchpotato.ini

# Clean environment variables not needed at runtine
# .env
unset COUCHPOTATO_PORT
unset SABNZBD_PORT
unset PLEX_PORT
unset TRANSMISSION_PORT
# .credentials
unset SABNZBD_API_KEY
unset COUCHPOTATO_API_KEY
unset NZBGEEK_API_KEY

exec ${*:1}
